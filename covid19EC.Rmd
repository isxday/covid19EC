---
title: "Casos de COVID-19 en Ecuador"
output: 
  html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo = F, include = F}
# Definir idioma de Fecha
Sys.setlocale("LC_TIME", "Spanish")

# Cargar librerias 
library(ggplot2)
library(dplyr)
library(sf)
library(tmap)
library(plotly)
library(reshape2)

# Leer datos recopilados por Pablo Reyes (https://twitter.com/PabloRA19/status/1241964053406285825)
casos = read.csv('https://raw.githubusercontent.com/pablora19/COVID19_EC/master/covid_ec.csv', sep = ',') %>% 
  mutate(fecha = as.Date(fecha, format = '%d/%m/%Y'))

# Convertir NaN en NA
is.nan.data.frame <- function(x){
  do.call(cbind, lapply(x, is.nan))
}
casos[is.nan(casos)] <- NA

# Corregir errores:
## Codigos de cantones no tienen el zero inicial
## Crear columna con codigo de provincia para union
casos_canton = casos %>% 
  # mutate(id_canton = ifelse(nombre_canton == 'salitre', 919, id_canton)) %>% 
  mutate(id_canton = as.factor(sprintf("%04d", id_canton))) %>% 
  mutate(id_prov = substr(id_canton, start = 1, stop = 2))

# Calcular casos acumulados por provincia para graficar 
casos_provincia = casos_canton %>% group_by(fecha, id_prov) %>% 
  summarize(casos_confirmados_prov = sum(casos_confirmados)) 

# Extraer info relevante a nivel nacional
casos_nacional = casos_canton %>% group_by(fecha) %>% 
  mutate(casos_confirmados = sum(casos_confirmados)) %>% 
  summarize_at(vars(7:15), first)

# Descargar provincias y cantones de Ecuador
if (!dir.exists("data")) dir.create("data")
src = 'http://www.ecuadorencifras.gob.ec//documentos/web-inec/Cartografia/Clasificador_Geografico/2015/SHP.zip'
dst = 'data/inec.zip'
if (!file.exists(dst)) {
  download.file(src, dst)
  unzip(dst, exdir = "data")
}

# Cargar los archivos
provincias = st_read('data/SHP/nxprovincias.shp') %>% st_simplify(dTolerance = 1000)
cantones = st_read('data/SHP/nxcantones.shp') %>% st_simplify(dTolerance = 500)

# Añadir conteo de casos a capa de provincias
provincias_casos = inner_join(provincias, casos_provincia, by = c('DPA_PROVIN' = 'id_prov'))

# Añadir conteo de casos a capa de cantones
cantones_casos = inner_join(cantones, casos_canton, by = c('DPA_CANTON'='id_canton'))

# Crear punto falso para colocar casos diarios
point = st_sf(st_sfc(st_point(c(-85,-3))), crs = 4326) %>% st_transform(32717)
nacional_casos = casos_nacional %>% 
  mutate(geometry = st_geometry(point)) %>% 
  st_as_sf() %>% 
  mutate(casos = paste('Total:', casos_confirmados))
```

```{r, echo = F, include = F}
# Crear un mapa animado para mostrar la evolución de casos por día.
tm = tm_shape(provincias) +
  tm_polygons(col = 'grey80', border.col = 'white', border.alpha = 1, lwd = 0.5) +
  tm_shape(provincias_casos) +
  tm_polygons(
    title = 'Casos Confirmados',
    col = 'casos_confirmados_prov', 
    border.col = 'white',
    border.alpha = 0.5,
    lwd = 1,
    palette = 'YlOrRd',
    style = 'jenks', 
    legend.show = F
  ) +
  tm_facets(along = 'fecha', free.coords = FALSE) +
  tm_shape(provincias_casos %>% st_centroid()) +
  tm_text(text = 'casos_confirmados_prov', size = 0.4, bg.color = 'white', bg.alpha = 0.5) +
  tm_facets(along = 'fecha', free.coords = FALSE) +
  tm_shape(nacional_casos) +
  tm_text(
    text = 'casos', col = 'casos_confirmados', size = 1, 
    palette = 'YlOrRd', style = 'jenks', shadow = T, fontface = 'bold',
    legend.size.show = F, legend.col.show = F
  ) +
  tm_facets(along = 'fecha', free.coords = FALSE) +
  tm_credits("Datos según lo reporta el Servicio Nacional de Gestión de Riesgos y Emergencias recopilados por Pablo Reyes A.") +
  tm_layout(
    title = 'Casos Confirmados de COVID-19 en Ecuador',
    title.size = 0.7, title.position = c('left','top'),
    main.title.size = 0.6, main.title.position = 'right',
    frame = F
  )
tmap_animation(tm, filename = 'covid_prov.gif', width = 1200, height = 750, delay=60, restart.delay = 150)
```

# Situación Actual {.tabset}

## Inicio

```{r, echo = F, out.width= "75%", out.extra='style="float:right; padding:10px"'}
knitr::include_graphics('covid_prov.gif')
```

*Trabajo en progreso*

Situación al **`r format(max(cantones_casos$fecha), '%d de %B, %Y')`**:

<span style="color: orange; font-size: 20pt">**`r casos_nacional %>% filter(fecha == max(fecha)) %>% pull(casos_confirmados)`**</span>
Casos confirmados

<span style="color: red; font-size: 20pt">**`r casos_nacional %>% filter(fecha == max(fecha)) %>% pull(fallecidos)`**</span>
Fallecidos

<span style="color: green; font-size: 20pt">**`r casos_nacional %>% filter(fecha == max(fecha)) %>% pull(recuperados)`**</span>
Recuperados

<span style="color: grey; font-size: 20pt">**`r casos_nacional %>% filter(fecha == max(fecha)) %>% pull(casos_sosp)`**</span>
Casos con sospecha

<!-- <span style="color: grey; font-size: 18pt">**`r casos_nacional %>% filter(fecha == max(fecha)) %>% pull(cerco_epid_act)`**</span> -->
<!-- Cerco epidemiológico activo -->

<span style="color: grey; font-size: 24pt">**`r casos_nacional %>% filter(fecha == max(fecha)) %>% pull(muestras_tomadas)`**</span>
Muestras tomadas

## Casos a nivel Nacional

```{r, include = F}
g1 = casos_nacional %>% select(fecha, casos_confirmados, fallecidos, recuperados) %>%
  melt(id = 'fecha') %>% 
  mutate(
    variable = ifelse(
      variable == 'fallecidos', 'Fallecidos', 
      ifelse(variable == 'recuperados', 'Recuperados', 'Casos Confirmados')
    )
  ) %>% 
  ggplot() +
  geom_area(
    aes(
      x = fecha, y = value, fill = variable, group = variable,
      text = paste0('Fecha: ', fecha, '<br>', variable, ': ', value)
    )
  ) +
  xlab('') + ylab('') +
  scale_fill_manual('', values = c('grey', 'red', 'green'))#, labels = c('Casos Confirmados', 'Fallecidos', 'Recuperados')) 
```

```{r, echo = F, message=F, warning=F, out.width='100%'}
g1 %>% ggplotly(tooltip = 'text')
```

## Evolución de casos por provincia

```{r, include = F}
## Cambiar datos para poder incluir facetas con y sin Guayas
# prov_casos_2 <-  rbind(
#     cbind(provincias_casos, faceter = "Todas las Provincias")
#     , cbind(provincias_casos[provincias_casos$DPA_DESPRO != "GUAYAS" ,], faceter = "Sin Guayas")
#     #other subsets go here...
# )

## Crear una paleta de colores aleatorios
library(randomcoloR)
n = length(unique(provincias_casos$DPA_PROVIN))
palette = distinctColorPalette(n)

g = ggplot(
  data = provincias_casos, 
  aes(
    x = fecha, y = casos_confirmados_prov, color = DPA_DESPRO, group = 1,
    text = paste('Fecha: ', fecha, '<br>', 'Casos Confirmados: ', casos_confirmados_prov, '<br>', 'Provincia: ', DPA_DESPRO)
  )) +
  geom_line() + geom_point() +
  scale_color_manual('PROVINCIAS', values = palette) +
  xlab('') + ylab('Casos Confirmados') +
  # facet_wrap(~faceter, ncol = 2, scales = 'free_y') +
  theme(legend.text = element_text(size = 7), legend.title = element_text(size = 8))
```

```{r, echo = F, out.width='100%'}
g %>% ggplotly(tooltip = 'text')
```

## Casos por Cantón al `r format(max(cantones_casos$fecha), '%d de %B, %Y')`

```{r, include = F}
cantones_label = cantones_casos %>% filter(fecha == max(fecha)) %>%  st_cast('POLYGON')
tmap_mode('view')
```

```{r, echo = F, out.width='100%'}
tm_shape(cantones_casos %>% filter(fecha == max(fecha))) +
  tm_polygons(
    title = 'Casos Confirmados',
    col = 'casos_confirmados', 
    border.col = 'white',
    border.alpha = 0.5,
    lwd = 1,
    palette = 'YlOrRd',
    style = 'jenks', 
    legend.show = T, id = 'DPA_DESCAN',
    popup.vars = c("Casos" = "casos_confirmados")
  ) 
  # tm_facets(along = 'fecha', free.coords = FALSE) +
  # tm_shape(cantones_label) +
  # tm_text(text = 'casos_confirmados', remove.overlap = F, size = 1, shadow = F)
  # tm_facets(along = 'fecha', free.coords = FALSE) +
  # tm_layout(main.title.size = 0.6, frame = F)
```

## Sobre el Sitio

Visualización de los casos de COVID-19 en el Ecuador, según lo reporta el [Servicio Nacional de Gestión de Riesgos y Emergencias](https://www.gestionderiesgos.gob.ec/informes-de-situacion-covid-19-desde-el-13-de-marzo-del-2020/){target="_blank"} con los [datos recopilados por Pablo Reyes A](https://github.com/pablora19/COVID19_EC){target="_blank"}. La actualización de los mismos dependerá de la actualización de los datos en el SNG y del repositiorio de Pablo Reyes A. Los datos se observan a nivel Nacional, por Provincia y por Cantón. Los gráficos en cada sección son interactivos. 

El código para reproducir las figuras, mapas y el sitio se encuentra en [GitHub](https://github.com/loreabad6/covid19EC).

**Última actualización:** `r format(Sys.time(), '%d/%m/%Y %H:%M %Z')`

**Autor:** Lorena Abad 

**Contacto:** [Twitter](https://twitter.com/loreabad6){target="_blank"}, [GitHub](https://github.com/loreabad6){target="_blank"}
