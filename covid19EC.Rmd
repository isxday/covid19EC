---
title: "Casos de COVID-19 en Ecuador"
output: 
  html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=FALSE}
htmltools::img(src = 'https://www.salud.gob.ec/wp-content/uploads/2020/03/img21.jpg',# knitr::image_uri(file.path('logo','covid.png')), 
               alt = 'logo', 
               style = 'position:absolute; top:0; right:0; padding:50px; width:15%')
```

```{r, echo = F, include = F}
# Definir idioma de Fecha
Sys.setlocale("LC_TIME", "Spanish")

# Cargar librerias 
library(ggplot2)
library(dplyr)
library(sf)
library(tmap)
library(plotly)
library(tidyr)

# Leer datos recopilados por Pablo Reyes (https://twitter.com/PabloRA19/status/1241964053406285825)
# "https://raw.githubusercontent.com/loreabad6/COVID19_EC/master/covid_ec.csv"
casos = read.csv('https://raw.githubusercontent.com/pablora19/COVID19_EC/master/covid_ec.csv', sep = ',') %>% 
  mutate(fecha_hora = paste(fecha, hora)) %>%
  mutate(fecha = as.Date(fecha, format = '%d/%m/%Y')) %>% 
  mutate(fecha_hora = as.POSIXct(fecha_hora, format = '%d/%m/%Y %H:%M'))

# Convertir NaN en NA
is.nan.data.frame <- function(x){
  do.call(cbind, lapply(x, is.nan))
}
casos[is.nan(casos)] <- NA

# Corregir errores:
## Codigos de cantones no tienen el zero inicial
## Crear columna con codigo de provincia para union
casos_canton = casos %>% 
  # mutate(id_canton = ifelse(nombre_canton == 'salitre', 919, id_canton)) %>% 
  mutate(id_canton = as.factor(sprintf("%04d", id_canton))) %>% 
  mutate(id_prov = substr(id_canton, start = 1, stop = 2))

# Calcular casos acumulados por provincia para graficar 
casos_provincia = casos_canton %>% group_by(fecha, id_prov) %>% 
  summarize(casos_confirmados_prov = sum(casos_confirmados)) 

# Extraer info relevante a nivel nacional
casos_nacional = casos_canton %>% group_by(fecha) %>% 
  mutate(casos_confirmados = sum(casos_confirmados)) %>% 
  summarize_at(vars(7:15), first)

# Descargar provincias y cantones de Ecuador
if (!dir.exists("data")) dir.create("data")
src = 'http://www.ecuadorencifras.gob.ec//documentos/web-inec/Cartografia/Clasificador_Geografico/2015/SHP.zip'
dst = 'data/inec.zip'
if (!file.exists(dst)) {
  download.file(src, dst)
  unzip(dst, exdir = "data")
}

# Cargar los archivos
provincias = st_read('data/SHP/nxprovincias.shp') %>% 
  st_simplify(dTolerance = 1000) %>% 
  mutate(region = ifelse(DPA_DESPRO == 'GALAPAGOS', 'Insular', 'Continental'))
cantones = st_read('data/SHP/nxcantones.shp') %>% st_simplify(dTolerance = 500)

# Añadir conteo de casos a capa de provincias
provincias_casos = inner_join(provincias, casos_provincia, by = c('DPA_PROVIN' = 'id_prov'))

# Añadir conteo de casos a capa de cantones
cantones_casos = inner_join(cantones, casos_canton, by = c('DPA_CANTON'='id_canton'))

# Crear punto falso para colocar casos diarios
point1 = st_sf(st_sfc(st_point(c(-85,-1.5))), crs = 4326) %>%
  st_transform(32717)
point2 = st_sf(st_sfc(st_point(c(-85,-3))), crs = 4326) %>% 
  st_transform(32717)
nacional_casos = casos_nacional %>% 
  mutate(geometry = st_geometry(point1)) %>% 
  st_as_sf() %>% 
  mutate(
    casos = paste('Casos:', casos_confirmados)
  )
nacional_extra = casos_nacional %>% 
  mutate(recuperados = replace_na(recuperados, 0)) %>% 
  mutate(geometry = st_geometry(point2)) %>% 
  st_as_sf() %>% 
  mutate(
    extra = paste('Fallecidos:', fallecidos, '\n', 'Recuperados: ', recuperados)
  )
    
```

```{r, echo = F, include = F}
# Crear un mapa animado para mostrar la evolución de casos por día.
tm = tm_shape(provincias) +
  tm_polygons(col = 'grey80', border.col = 'white', border.alpha = 1, lwd = 0.5) +
  tm_shape(provincias_casos) +
  tm_polygons(
    title = 'Casos Confirmados',
    col = 'casos_confirmados_prov', 
    border.col = 'white',
    border.alpha = 0.5,
    lwd = 1,
    palette = 'YlOrRd',
    style = 'jenks', 
    legend.show = F
  ) +
  tm_facets(along = 'fecha', free.coords = FALSE) +
  tm_shape(provincias_casos %>% st_centroid()) +
  tm_text(text = 'casos_confirmados_prov', size = 0.4, bg.color = 'white', bg.alpha = 0.5) +
  tm_facets(along = 'fecha', free.coords = FALSE) +
  tm_shape(nacional_casos) +
  tm_text(
    text = 'casos', col = 'casos_confirmados', size = 1,
    palette = 'YlOrRd', style = 'jenks', shadow = T, fontface = 'bold',
    legend.col.show = F
  ) +
  tm_facets(along = 'fecha', free.coords = FALSE) +
  tm_shape(nacional_extra) +
  tm_text(
    text = 'extra', col = 'grey50', size = 0.6,
    shadow = T, fontface = 'bold',
    legend.col.show = F
  ) +
  tm_facets(along = 'fecha', free.coords = FALSE) +
  tm_credits("Datos según lo reporta el Servicio Nacional de Gestión de Riesgos y Emergencias recopilados por Pablo Reyes A. Creado por Lorena Abad.") +
  tm_layout(
    title = 'Casos Confirmados de COVID-19 en Ecuador',
    title.size = 0.7, title.position = c('right','top'),
    main.title.size = 0.6, main.title.position = 'left',
    frame = F
    # bg.color = 'black', title.color = 'white', main.title.color = 'white'
  )
tmap_animation(tm, filename = 'covid_prov.gif', width = 1200, height = 750, delay=60, restart.delay = 150)
```

# {.tabset}

## Inicio

Situación al **`r format(max(cantones_casos$fecha_hora), '%d de %B %H:%M')`**:

```{r, echo = F, out.width= "80%", out.extra='style="float:right; padding:10px"'}
knitr::include_graphics('covid_prov.gif')
```

<center> 
<br><br>
<span style="color: orange; font-size: 20pt">**`r casos_nacional %>% filter(fecha == max(fecha)) %>% pull(casos_confirmados)`**</span><br>Casos confirmados

<span style="color: red; font-size: 20pt">**`r casos_nacional %>% filter(fecha == max(fecha)) %>% pull(fallecidos)`**</span><br>Fallecidos

<span style="color: green; font-size: 20pt">**`r casos_nacional %>% filter(fecha == max(fecha)) %>% pull(recuperados)`**</span><br>Recuperados

<br>
<span style="color: grey; font-size: 20pt">**`r casos_nacional %>% filter(fecha == max(fecha)) %>% pull(casos_sosp)`**</span><br>Casos con sospecha

<span style="color: grey; font-size: 20pt">**`r casos_nacional %>% filter(fecha == max(fecha)) %>% pull(muestras_tomadas)`**</span><br>Muestras tomadas

<!-- <span style="color: grey; font-size: 20pt">**`r casos_nacional %>% filter(fecha == max(fecha)) %>% pull(cerco_epid_act)`**</span> -->
<!-- Cerco epidemiológico actual -->

</center>

## Casos a nivel Nacional {.tabset}

### Estado de personas contagiadas

```{r, include = F}
casos_plot = casos_nacional %>% 
  select(fecha, fallecidos, recuperados, hosp_est, hosp_pron_res, estables_aislamiento_domiliciario, casos_confirmados) %>%
  gather(variable, value, -fecha, - casos_confirmados) %>% 
  mutate(
    variable = factor(ifelse(
      variable == 'fallecidos', 'Fallecidos', 
      ifelse(variable == 'recuperados', 'Recuperados', 
      ifelse(variable == 'hosp_est', 'Hospitalizados estables',
      ifelse(variable == 'hosp_pron_res','Hospitalizados con pronóstico reservado',
      ifelse(variable == 'estables_aislamiento_domiliciario', 'Estables en aislamiento domiciliario', ''
    ))))), 
    levels = c('Estables en aislamiento domiciliario', 'Hospitalizados estables', 'Hospitalizados con pronóstico reservado', 'Fallecidos', 'Recuperados'),
    ordered = T)
  ) %>% 
  mutate(legend_label = paste0(variable, ": ", value))

g1 = ggplot(casos_plot) +
  geom_col(
    aes(
      x = fecha, y = value, fill = variable, group = variable,
      text = paste0('Fecha: ', fecha, '<br>', variable, ': ', value)
    )
  ) +
  geom_point(aes(x = fecha, y = casos_confirmados,
                 text = paste0('Fecha: ', fecha, '<br>', 'Casos confirmados', ': ', casos_confirmados)
                 )) +
  geom_line(aes(x = fecha, y = casos_confirmados)) +
  xlab('') + ylab('') +
  scale_fill_manual(
    'Estado de personas contagiadas', 
    # labels = casos_plot %>% filter(fecha == max(fecha)) %>% select(legend_label) %>% as.vector(),
    values = c('grey70', 'blue', 'darkblue', 'red', 'green')
  ) +
  scale_x_date(date_breaks = '2 day', date_labels = '%d/%m') +
  theme(
    panel.background = element_rect(fill = 'grey95')
  )
```

```{r, echo = F, message=F, warning=F, out.width='100%'}
g1 %>% ggplotly(tooltip = 'text', dynamicTicks = T) %>%
  # rangeslider() %>% 
  layout(legend = list(
    # title = list(text = 'Estado de personas contagiadas'),
    orientation = "v", y = 0.95, x = 0.05, bgcolor = "rgba(0, 0, 0, 0)"
    )
  )
```

### Casos por estado del paciente y grupo etario

```{r, echo = F, include = F}
## Datos del MSP
msp = read.csv('https://raw.githubusercontent.com/pablora19/COVID19_EC/master/age%20range%20-%20alive_deads.csv', encoding = 'UTF-8') %>% 
  mutate(
    Fecha = as.Date(Fecha, format = '%d/%m/%Y'),
    rango.edad = factor(rango.edad, 
                        levels = c('<1 año', '1 - 4 años', '5 - 9 años', 
                                   '10 - 14 años', '15 - 19 años', 
                                   '20 - 49 años', '50 - 64 años', '> 65 años'),
                        ordered = T)
  ) %>% 
  gather(estado, casos, -Fecha, -rango.edad, -BoletinMSP) %>% 
  rename('Rango de Edad' = rango.edad)

g2 = ggplot(msp) + 
  geom_col(aes(y = casos, x = Fecha, fill = `Rango de Edad`), 
           position = position_dodge()) + 
  facet_wrap(~estado, scales = 'free_y', nrow = 2) +
  scale_x_date(date_breaks = '1 day', date_labels = '%d/%m') +
  xlab('') + ylab('') +
  theme(panel.background = element_rect(fill = 'grey95'))
```

```{r, echo = F, message=F, warning=F, out.width='100%'}
g2 %>% ggplotly(dynamicTicks = F)
```

### Casos por género y grupo etario 

```{r, echo = F, include = F}
## Datos del MSP
msp2 = read.csv('https://raw.githubusercontent.com/pablora19/COVID19_EC/master/age%20range%20-%20gender%20fem_mal%20.csv') %>% #, encoding = 'UTF-8') %>% 
  mutate(
    Fecha = as.Date(Fecha, format = '%d/%m/%Y'),
    Rango.edad = factor(Rango.edad, 
                        levels = c('<1 año', '1 - 4 años', '5 - 9 años', 
                                   '10 - 14 años', '15 - 19 años', 
                                   '20 - 49 años', '50 - 64 años', '> 65 años'),
                        ordered = T)
  ) %>% 
  gather(genero, casos, -Fecha, -Rango.edad, -BoletinMSP) %>% 
  rename('Rango de Edad' = Rango.edad)

g3 = ggplot(msp2) + 
  geom_col(aes(y = casos, x = Fecha, fill = `Rango de Edad`), 
           position = position_dodge()) + 
  facet_wrap(~genero, nrow = 1) +
  scale_x_date(date_breaks = '2 day', date_labels = '%d/%m') +
  xlab('') + ylab('') +
  theme(panel.background = element_rect(fill = 'grey95'))
```

```{r, echo = F, message=F, warning=F, out.width='100%'}
g3 %>% ggplotly(dynamicTicks = F)
```


## Casos por Provincia

```{r, include = F}
## Cambiar datos para poder incluir facetas con y sin Guayas
# prov_casos_2 <-  rbind(
#     cbind(provincias_casos, faceter = "Todas las Provincias")
#     , cbind(provincias_casos[provincias_casos$DPA_DESPRO != "GUAYAS" ,], faceter = "Sin Guayas")
#     #other subsets go here...
# )

## Crear una paleta de colores aleatorios
library(randomcoloR)
n = length(unique(provincias_casos$DPA_PROVIN))
palette = distinctColorPalette(n)

g = ggplot(
  data = provincias_casos, 
  aes(
    x = fecha, y = casos_confirmados_prov, color = DPA_DESPRO, group = 1, 
    #frame = fecha, 
    text = paste(
      'Fecha: ', fecha, '<br>', 
      'Casos Confirmados: ', casos_confirmados_prov, '<br>', 
      'Provincia: ', DPA_DESPRO)
  )) +
  geom_line() + geom_point() +
  scale_color_manual('PROVINCIAS', values = palette) +
  scale_x_date(date_breaks = '2 day', date_labels = '%d/%m') +
  xlab('') + ylab('Casos Confirmados') +
  # facet_wrap(~faceter, ncol = 2, scales = 'free_y') +
  theme(
    legend.text = element_text(size = 7), 
    legend.title = element_text(size = 8), 
    panel.background = element_rect(fill = 'grey95')
    )

g_log = g + scale_y_log10() + ylab ('Casos Confirmados (log10)')
```

```{r, echo = F, out.width='100%'}
plotly1 = ggplotly(g, tooltip = 'text')
plotly2 = ggplotly(g_log, tooltip = 'text')
plotly1 
```

## Casos por Cantón 

Casos al `r format(max(cantones_casos$fecha_hora), '%d de %B, %Y %H:%M')`

```{r, include = F}
cantones_label = cantones_casos %>% filter(fecha == max(fecha)) %>%  st_cast('POLYGON')
tmap_mode('view')
```

```{r, echo = F, out.width='100%'}
tm_shape(cantones) +
  tm_polygons(
    alpha = 0, border.col = 'white', border.alpha = 0.5, 
    popup.vars = NULL, group = 'Límite cantonal'
  ) +
  tm_shape(cantones_casos %>% filter(fecha == max(fecha))) +
  tm_polygons(
    group = 'Casos confirmados por Cantón',
    title = 'Casos Confirmados',
    col = 'casos_confirmados', 
    alpha = 0.8,
    border.col = 'white',
    border.alpha = 0.5,
    lwd = 1,
    palette = 'YlOrRd',
    style = 'jenks', 
    legend.show = T, id = 'DPA_DESCAN',
    popup.vars = c("Casos" = "casos_confirmados", "Provincia" = "DPA_DESPRO")
  ) 
  # tm_facets(along = 'fecha', free.coords = FALSE) +
  # tm_shape(cantones_label) +
  # tm_text(text = 'casos_confirmados', remove.overlap = F, size = 1, shadow = F)
  # tm_facets(along = 'fecha', free.coords = FALSE) +
  # tm_layout(main.title.size = 0.6, frame = F)
```

## Sobre el Sitio

*Trabajo en progreso*

Visualización de los casos de COVID-19 en el Ecuador, según lo reporta el [Servicio Nacional de Gestión de Riesgos y Emergencias](https://www.gestionderiesgos.gob.ec/informes-de-situacion-covid-19-desde-el-13-de-marzo-del-2020/){target="_blank"} y el [Ministerio de Salud Pública](https://www.salud.gob.ec/gacetas-epidemiologicas-coronavirus-covid-19/){target="_blank"}.

Los datos son recopilados por Pablo Reyes A en [este repositorio](https://github.com/pablora19/COVID19_EC){target="_blank"}. 

El shapefile de provincias y cantones es obtenido del [INEC](https://www.ecuadorencifras.gob.ec/category/cartografia-2/){target="_blank"}. 

La actualización de los mismos dependerá de la actualización del repositiorio de Pablo Reyes A. 

Los datos se observan a nivel Nacional, por Provincia y por Cantón. Los gráficos en cada sección son interactivos. 

El código para reproducir las figuras, mapas y el sitio se encuentra en [GitHub](https://github.com/loreabad6/covid19EC){target="_blank"}. Todo es creado en R, con ayuda de los paquetes
[rmarkdown](https://rmarkdown.rstudio.com/){target="_blank"}, [sf](https://r-spatial.github.io/sf/){target="_blank"}, [ggplot2](https://ggplot2.tidyverse.org/){target="_blank"}, [tmap](https://github.com/mtennekes/tmap){target="_blank"}, [plotly](https://plotly.com/r/){target="_blank"},
[gganimate](https://gganimate.com/){target="_blank"}, [magick](https://docs.ropensci.org/magick/){target="_blank"}, [tidyr](https://tidyr.tidyverse.org/){target="_blank"} y [dplyr](https://dplyr.tidyverse.org/){target="_blank"}.

**Última actualización:** `r format(Sys.time(), '%d/%m/%Y %H:%M %Z')`

**Autor:** Lorena Abad 

<!-- https://de.wikipedia.org/wiki/Twitter#/media/Datei:Twitter_bird_logo_2012.svg -->
**Contacto:** [![Twitter](logo/twitter.png){width=3%}](https://twitter.com/loreabad6){target="_blank"} [![Github](logo/github.png){width=3%}](https://github.com/loreabad6){target="_blank"}
